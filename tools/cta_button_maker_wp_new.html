<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CTA Buttons Maker [WP-NEW]</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.pumpkin.min.css" />
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  
  <h5>Paste the code here (from Code Editor on WP):</h5>
  <textarea id="inputText"></textarea>

  <button id="convertBtn" class="within-frame-button" >Convert</button>

  <h5>Paste the code from here to Code Editor on WP:</h5>
  <textarea id="outputText"></textarea>

<script>
  document.getElementById('convertBtn').addEventListener('click', function () {
    const input = document.getElementById('inputText').value;

    const regex =
      /<!--\s*wp:paragraph[^>]*-->\s*<p[^>]*>\s*(?:<(strong|em|b|i|u|br)[^>]*>\s*)*<a\s+href="([^"]+)"[^>]*>([\s\S]*?)<\/a>\s*(?:<\/\1>\s*)*(?:&nbsp;|&#160;|\s|<br\s*\/?>)*<\/p>\s*<!--\s*\/wp:paragraph\s*-->/gi;

    const output = input.replace(regex, (match, _, url, rawLinkText) => {
      // Ensure exactly one link
      const totalLinks = (match.match(/<a\s+/g) || []).length;
      if (totalLinks !== 1) return match;

      /* -----------------------------
         Clean CTA text (HTML → text)
      ------------------------------*/
      const temp = document.createElement('div');
      temp.innerHTML = rawLinkText;
      const fullText = temp.textContent.trim();

      /* -----------------------------
         Derive product name
      ------------------------------*/
      const stopWords = ['get', 'the', 'on', 'amazon', 'eneba'];
      let productName = fullText
        .split(/\s+/)
        .filter(word => !stopWords.includes(word.toLowerCase()))
        .join(' ')
        .trim();

      if (!productName) return match; // safety

      /* -----------------------------
         Platform logic
      ------------------------------*/
      const isAmazon = url.includes('amazon.');
      const isEneba = url.includes('eneba.');

      const ctaText = isAmazon
        ? 'Get it on Amazon'
        : isEneba
        ? 'Get it on Eneba'
        : 'Get it';

      const relAttr = isAmazon
        ? 'noreferrer noopener nofollow'
        : 'noreferrer noopener';

      /* -----------------------------
         Winner Badge output
      ------------------------------*/
      const lines = [];

      lines.push(
        `<!-- wp:eneba/winner-badge {"productName":"${productName}","ribbonText":"","ctaText":"${ctaText}","ctaLink":"${url.replace(/&/g, '\\u0026')}"} -->`
      );
      lines.push('<div class="wp-block-eneba-winner-badge">');
      lines.push('  <div class="wp-block-eneba-winner-badge-ribbon">★ Winner</div>');
      lines.push('  <div class="wp-block-eneba-winner-badge-content">');
      lines.push('    <div class="wp-block-eneba-winner-badge-product-container">');
      lines.push(
        `      <div class="wp-block-eneba-winner-badge-product-name">${productName}</div>`
      );
      lines.push('    </div>');
      lines.push('    <div class="wp-block-eneba-winner-badge-cta-container">');
      lines.push(
        `      <a href="${url}" class="wp-block-eneba-winner-badge-cta" target="_blank" rel="${relAttr}">`
      );
      lines.push(
        `        <span class="wp-block-eneba-winner-badge-cta-text">${ctaText}</span>`
      );
      lines.push('      </a>');
      lines.push('    </div>');
      lines.push('  </div>');
      lines.push('</div>');
      lines.push('<!-- /wp:eneba/winner-badge -->');

      return lines.join('\n');
    });

    document.getElementById('outputText').value = output;
  });
</script>
  <script src="../js/iframe-auto-resizer.js"></script>
</body>
</html>